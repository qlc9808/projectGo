<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oracle.projectGo.learningGroupMapper">
    <select id="NoTotalLearningContentCnt" parameterType="int" resultType="int">
        <![CDATA[
            SELECT  COUNT(*)
            FROM    payments a
            join    gameContents b
            on      a.contentId = b.id
            WHERE   a.userId = #{userId}
            AND     b.subscribleStart <= SYSDATE
            AND     b.subscribleEnd >= SYSDATE
        ]]>
    </select>

    <select id="NoLearningContentList" parameterType="int" resultType="GameContents">
        <![CDATA[
            SELECT   *
            FROM     payments a
            JOIN     gameContents b
            ON       a.contentId = b.id
            WHERE    a.userId = #{userId}
            AND      b.subscribleStart <= SYSDATE
            AND      b.subscribleEnd >= SYSDATE
            ORDER BY a.contentid ASC
        ]]>
    </select>

    <select id="NoInsertFormLearningContent" parameterType="int" resultType="GameContents">
        SELECT  a.userId pay_userId, b.name, c.*
        FROM    payments a
        JOIN    users b
        ON      a.userId = b.id
        JOIN    gameContents c
        ON      a.contentId = c.id
        WHERE   c.id = #{id}
    </select>

    <insert id="NoInsertLearningGroup" parameterType="LearningGroup">
        INSERT INTO learningGroup(id, contentId, userId, name, startDate, endDate, groupSize, etc1, etc2)
        VALUES(LEARNINGGROUP_ID_SEQ.NEXTVAL, #{id}, #{userId}, #{name}, #{startDate}, #{endDate}, #{groupSize}, #{etc1}, #{etc2})
    </insert>

    <select id="NoTotalLearningGroupCnt" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM   learningGroup
            WHERE  userId = #{userId}
            AND    startDate <= SYSDATE
            AND    endDate >= SYSDATE
        ]]>
    </select>

    <select id="NoLearningGroupList" parameterType="int" resultType="LearningGroup">
        <![CDATA[
            SELECT   a.*, b.title
            FROM     learningGroup a
            JOIN     gameContents b
            ON       a.contentId = b.id
            WHERE    a.userId = #{userId}
            AND      a.startDate <= SYSDATE
            AND      a.endDate >= SYSDATE
            ORDER BY a.id ASC
        ]]>
    </select>

    <select id="NoDetailLearningGroup" parameterType="learningGroup" resultType="LearningGroup">
        SELECT  a.*, b.contentId, b.name, b.startDate, b.endDate, b.groupSize, b.etc1,
                b.etc2, c.name studentName, c.phone, c.email, c.address, d.title
        FROM    learninggroupmember a
        JOIN    learninggroup b
        ON      a.groupid = b.id
        JOIN    users c
        ON      a.userid = c.id
        JOIN    gamecontents d
        ON      b.contentId = d.id
        WHERE   a.groupid = #{id}
    </select>

    <select id="NoUpdateFormLearningGroup" parameterType="int" resultType="LearningGroup">
        SELECT  a.*, b.title, b.maxSubscribers, c.name userName
        FROM    learningGroup a
        JOIN    gameContents b
        ON      a.contentId = b.id
        JOIN    users c
        ON      a.userId = c.id
        WHERE   a.id = #{id}
    </select>

    <update id="NoUpdateLearningGroup" parameterType="LearningGroup">
        UPDATE learningGroup SET name = #{name}, startDate = #{startDate},
                                 endDate = #{endDate}, groupSize = #{groupSize},
                                 etc1 = #{etc1}, etc2 = #{etc2}
        WHERE id = #{id}
    </update>

    <delete id="NoDeleteLearningGroupMember" parameterType="int">
        DELETE learningGroupMember WHERE groupId = #{id}
    </delete>

    <delete id="NoDeleteLearningGroup" parameterType="int">
        DELETE learningGroup WHERE id = #{id}
    </delete>

    <select id="NoTotalApprovalGroupMemberCnt" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM learningGroupMember
        WHERE groupId = #{id}
    </select>


    <select id="getGroupMemberByGroupId" resultType="Users">
        SELECT users.*
        FROM learningGroupMember lgm
        JOIN users ON lgm.userid = users.id
        WHERE lgm.groupId = #{groupId}
    </select>
    <select id="getGroupMembersByEducatorId" resultType="Users">
        SELECT u.id, u.nickname, u.userType, u.name, lg.name as groupName
        FROM learningGroup lg
        JOIN learningGroupMember lgm ON lg.id = lgm.groupId
        JOIN users u ON lgm.userId = u.id
        WHERE lg.userId = #{educatorId}
    </select>

    <!--강한빛 -->
    <select id="signUpLearningGroup" resultType="LearningGroup">
        SELECT   lg.id, lg.contentId, lg.userId, lg.name, lg.startDate, lg.endDate, lg.groupSize, lg.etc1, lg.etc2, g.imageName, g.imagePath, u.name as userName
        FROM     LearningGroup lg
        JOIN     Users u ON lg.userId = u.id
        JOIN     GameContents g ON lg.contentId = g.id
        ORDER BY lg.id desc
    </select>

</mapper>